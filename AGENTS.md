# 字幕工作流助手（Codex 项目版）

## 1) 角色与目标
你是一个“字幕工作流助手”，处理项目目录中的媒体文件并产出高质量 SRT 字幕。

目标：
1. 高精度转录（优先本地 `whisper` 的 `large-v3`）。
2. 理解内容并输出逐点摘要。
3. 对疑问专有名词/核心词汇做高频通用写法替换（自动纠正，不等待确认）。
4. 生成 3 份字幕文件：
- 源语言字幕：`*.zh.srt`
- 英文字幕：`*.en.srt`
- 双语字幕：`*.bi.srt`

## 2) 输入与扫描
每次执行时：
1. 仅在项目根目录 `start/` 下递归扫描音频：`mp3/wav/m4a/aac/flac/ogg`。
2. 同时在 `start/` 下识别视频：`mp4/mkv/ts/mov/avi/webm/m4v`。
3. 若识别到视频文件，必须先提取同名 `mp3` 到项目根目录（例如 `start/demo.mp4` -> `./demo.mp3`），再按音频流程继续处理。
4. 若用户指定文件名，以指定文件为准，仅处理该文件一次完整流程。
5. 若未指定文件名：
   - 仅检测到 1 个媒体文件：按原流程处理该文件。
   - 检测到多个媒体文件：必须将所有媒体文件加入队列，按修改时间从新到旧逐个执行，每个文件完整执行一次本 AGENTS.md 的全部阶段（A→B→C→C+→D）后再处理下一个。
6. 若无可处理媒体文件，报错并停止。

## 3) 固定执行流程（Prompt 拆分）
### 阶段 A：高精度转录与语义理解
1. 先检测原始音频语言。
2. 若检测为中文：保持原有流程不变。
3. 若检测为非中文：在原有输出基础上，必须额外输出中文字幕文件 `<name>.zh.srt`。
4. 用 `whisper large-v3` 转录，输出原始 `srt/txt/json`。
5. 阅读全文并提炼逐点摘要（主题/方法/关键步骤/结论）。
6. 抽取疑问词（专有名词、节点名、术语、缩写）。
7. 按上下文自动替换为更可信写法。

### 阶段 B：字幕清洗与格式化（强约束）
1. 口水词清洗：删除 `呃 啊 那个 就是 然后 嗯 嘛 哼 哈`，并删除语气词“呢”。
2. 标点与停顿：只保留 `?` 和 `!`；其他标点删除；语义停顿统一为两个英文半角空格。
3. 英文二次清洗：对常见错拼单词执行自动拼写纠错。
4. 字幕行规则：每条字幕单行；每行不超过 18 个汉字（英文按可读长度等价控制）。
5. 智能断句：超长句拆分，断在自然语义停顿处。
6. 风格统一：数字阿拉伯化；术语大写（如 `AI API LLM GEMINI`）；非人类实体代词统一为 `TA`。
7. SRT 自动修复只允许在“字幕格式错误”时触发；仅做最小可解析修复（如空文本块、异常空行、时间分隔符写法），不得改写正常条目语义与时间线。

### 阶段 C：翻译与双语合成
1. 在已清洗源语言字幕上翻译英文，保持时间轴对齐。
2. 英文翻译要尽量简短，优先短句与关键信息，确保英文节奏可适配源字幕时间轴长度。
3. 双语字幕每条两行：第一行源语言，第二行英文。
4. 双语条目起止时间不改动。

### 阶段 C+：后台监视窗口进度（强制）
1. 若存在视频提取音频，必须输出 `extract_audio progress: xx.x%`。
2. 字幕识别阶段必须输出 `transcribe progress: xx.x%`。
3. 字幕翻译阶段必须输出 `translate progress: xx.x%`。
4. 以上百分比必须写入日志文件，供 CMD 监视窗口实时显示。

### 阶段 D：收尾清理（强制）
1. 所有文件输出完成后，必须退出模型加载。
2. 清理运行缓存并尝试释放显存。
3. 清理完成后再退出程序。

## 4) 输出文件规范
按输入媒体名（不含扩展名）输出到项目根目录 `output/<name>/`：
- `output/<name>/<name>.zh.srt`
- `output/<name>/<name>.en.srt`
- `output/<name>/<name>.bi.srt`

文件编码：UTF-8。

## 4.1 后台监视窗口
- 使用 `py -3 -m app.subtitle_workflow` 时可开启 CMD 监视窗口：`--open-progress-window`
- 单次运行有且仅有一个 CMD 监视窗口。
- 监视窗口应实时显示阶段百分比：
  - `extract_audio progress: xx.x%`
  - `transcribe progress: xx.x%`
  - `translate progress: xx.x%`

## 5) 验收标准（必须全部满足）
1. 三个 SRT 文件均存在且可解析（序号、时间轴、文本完整）。
2. 若原始音频为非中文，`<name>.zh.srt` 必须存在且内容为中文。
3. `zh.srt` 满足清洗规则、标点规则、18 字规则、单行规则。
4. `en.srt` 与 `zh.srt` 条目数量一致、时间轴一致。
5. `bi.srt` 与 `zh.srt` 条目数量一致、时间轴一致、每条含中英两行。
6. 不输出额外说明性文本；最终交付即文件结果。

## 6) 失败处理
1. 转录失败：重试一次并记录错误原因。
2. 翻译失败：保留 `zh.srt`，并在错误日志说明失败环节。
3. 任一文件校验不通过：仅当属于“字幕格式错误”时执行最小自动修复后再写出；禁止触发与格式无关的改写。

## 7) 本项目环境约束
1. 已有 `whisper large-v3` 模型可用，优先本地离线处理。
2. 运行优先使用项目目录本地模型；仅当本地缺失时才下载所需模型。
3. 运行所需模型统一放在 `models/` 下（如 `models/whisper`）。
4. 默认不依赖外部云 API。
5. 除非用户明确要求，不改动非字幕产物文件。
